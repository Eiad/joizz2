<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jojiz - منتجات ملابس الأطفال</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="products.css">
    <link rel="stylesheet" href="modal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="mobile-nav.css">
</head>
<body>
    <!-- Mobile Navigation -->
    <div class="mobile-header">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="mobile-logo">
            <a href="/">
                <img src="img/jojiz.png" alt="Jojiz Logo">
            </a>
        </div>
    </div>
    
    <!-- Mobile Side Navigation -->
    <div class="mobile-sidenav" id="mobileSidenav">
        <div class="sidenav-header">
            <button class="close-sidenav" id="closeSidenav">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidenav-content">
            <div class="sidenav-user">
                <div class="user-info">
                    <span>WELCOME</span>
                    <a href="login.html" class="login-register" id="mobileAuthLink">LOGIN/REGISTER</a>
                </div>
            </div>
            <div class="sidenav-links">
                <a href="index.html" class="sidenav-link">
                    <i class="fas fa-home"></i>
                    <span>الصفحة الرئيسية</span>
                </a>
                <a href="products.html" class="sidenav-link">
                    <i class="fas fa-store"></i>
                    <span>المتجر</span>
                </a>
                <a href="category.html" class="sidenav-link">
                    <i class="fas fa-store"></i>
                    <span>الفئات</span>
                </a>
                <a href="cart.html" class="sidenav-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>سلة التسوق</span>
                </a>
                <!-- <a href="#" class="sidenav-link lang-switch">
                    <i class="fas fa-globe"></i>
                    <span>تغيير اللغة</span>
                </a> -->
            </div>
            <div class="sidenav-contact">
                <p>HOTLINE 24/7</p>
                <a href="tel:01017620115" class="phone">01017620115</a>
                <div class="social-icons">
                    <!-- Social media links will be loaded dynamically from the API -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overlay for when sidenav is open -->
    <div class="sidenav-overlay" id="sidenavOverlay"></div>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="left-section">
                <span class="hotline">HOTLINE 24/7</span>
                <a href="tel:01017620115" class="phone">01017620115</a>
            </div>
            <div class="right-section">
                <div class="cart">
                    <span id="cart-total">0.00EGP</span>
                    <a href="cart.html"><i class="fas fa-shopping-cart"></i></a>
                </div>
                <div class="auth">
                    <span>WELCOME</span>
                    <a href="login.html" class="login-register" id="authLink">LOGIN/REGISTER</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav class="main-nav">
        <div class="container">
            <div class="logo">
                <a href="/">
                    <img src="img/jojiz.png" alt="Jojiz Logo">
                </a>
            </div>
            <div class="nav-links">
                <a href="#" class="lang-switch">ar<i class="fas fa-globe"></i></a>
                <a href="products.html">المتجر</a>
                <a href="category.html">الفئات</a>
                <a href="index.html">الصفحة الرئيسية</a>
            </div>
            <div class="search-box">
                <input type="text" placeholder="بحث">
                <button><i class="fas fa-search"></i></button>
            </div>
        </div>
    </nav>
<!-- Page Header -->
<div class="page-header">
    <h1>منتجاتنا</h1>
    <div class="breadcrumb">
        <a href="index.html">الرئيسية</a>
        <span>/</span>
        <span>المتجر</span>
    </div>
</div>
    <!-- Products Page Content -->
    
    <div class="products-page">
        <!-- Move the filter toggle button here, before products-content -->
            <div class="mobile-filter-toggle">
                <button id="filterToggleBtn">
                    <i class="fas fa-filter"></i>
                    تصفية المنتجات
                </button>
            </div>
        <div class="container">
            
            
            <div class="products-content">
                <!-- Sidebar Filters -->
                <div class="filters-sidebar" id="filtersSidebar">
                    <div class="filter-header">
                        <h3 class="filter-title">خيارات التصفية</h3>
                        <button class="close-filters" id="closeFilters">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-filter"></i>
                            الفلتر
                        </h3>
                        
                        <!-- Category Filter -->
                        <div class="filter-group">
                            <h4 class="filter-group-title">الفئة</h4>
                            <div class="filter-options">
                                <div class="filter-option">
                                    <input type="checkbox" id="category-1" name="category">
                                    <label for="category-1">
                                        <i class="fas fa-user"></i>
                                        <span>(0)</span>
                                    </label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox" id="category-2" name="category">
                                    <label for="category-2">
                                        <i class="fas fa-user-tie"></i>
                                        <span>(0)</span>
                                    </label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox" id="category-3" name="category">
                                    <label for="category-3">
                                        <i class="fas fa-baby"></i>
                                        <span>(1)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rating Filter -->
                        <div class="filter-group">
                            <h4 class="filter-group-title">التقييم</h4>
                            <div class="filter-options">
                                <div class="filter-option rating-option">
                                    <input type="checkbox" id="rating-5" name="rating">
                                    <label for="rating-5">
                                        <div class="stars">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                        </div>
                                        <span>(0)</span>
                                    </label>
                                </div>
                                <div class="filter-option rating-option">
                                    <input type="checkbox" id="rating-4" name="rating">
                                    <label for="rating-4">
                                        <div class="stars">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                        </div>
                                        <span>(0)</span>
                                    </label>
                                </div>
                                <div class="filter-option rating-option">
                                    <input type="checkbox" id="rating-3" name="rating">
                                    <label for="rating-3">
                                        <div class="stars">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                        </div>
                                        <span>(0)</span>
                                    </label>
                                </div>
                                <div class="filter-option rating-option">
                                    <input type="checkbox" id="rating-2" name="rating">
                                    <label for="rating-2">
                                        <div class="stars">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                        </div>
                                        <span>(0)</span>
                                    </label>
                                </div>
                                <div class="filter-option rating-option">
                                    <input type="checkbox" id="rating-1" name="rating">
                                    <label for="rating-1">
                                        <div class="stars">
                                            <i class="fas fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                            <i class="far fa-star"></i>
                                        </div>
                                        <span>(0)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Brands Filter -->
                        <!-- <div class="filter-group">
                            <h4 class="filter-group-title">العلامات التجارية</h4>
                            <div class="filter-options">
                                <div class="filter-option">
                                    <input type="checkbox" id="brand-1" name="brand">
                                    <label for="brand-1">Sail <span>(0)</span></label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox" id="brand-2" name="brand">
                                    <label for="brand-2">Bata <span>(0)</span></label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox" id="brand-3" name="brand">
                                    <label for="brand-3">Puma <span>(0)</span></label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox" id="brand-4" name="brand">
                                    <label for="brand-4">Lacoste <span>(0)</span></label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox" id="brand-5" name="brand">
                                    <label for="brand-5">B&G <span>(0)</span></label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox" id="brand-6" name="brand">
                                    <label for="brand-6">Adidas <span>(0)</span></label>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </div>
                
                <!-- Products Grid -->
                <div class="products-grid-container">
                    <div class="products-toolbar">
                        <div class="products-count">عرض 1-12 من 36 منتج</div>
                        <div class="products-sorting">
                            <label for="sort-by">ترتيب حسب:</label>
                            <select id="sort-by">
                                <option value="popularity">الأكثر شعبية</option>
                                <option value="price-low">السعر: من الأقل للأعلى</option>
                                <option value="price-high">السعر: من الأعلى للأقل</option>
                            </select>
                        </div>
                        <!-- <div class="view-options">
                            <button class="grid-view active"><i class="fas fa-th-large"></i></button>
                            <button class="list-view"><i class="fas fa-list"></i></button>
                        </div> -->
                    </div>
                    
                    <div class="products-grid"></div>
                    
                    <!-- Pagination -->
                    <div class="pagination">
                        <a href="#" class="active">1</a>
                        <a href="#">2</a>
                        <a href="#">3</a>
                        <a href="#" class="next"><i class="fas fa-chevron-left"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Popup Modal - Same as in index.html -->
    <div id="productModal" class="product-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="product-modal-container">
                <div class="product-modal-image">
                    <img id="modalProductImage" src="" alt="صورة المنتج">
                </div>
                <div class="product-modal-details">
                    <h2 id="modalProductTitle"></h2>
                    <div class="product-modal-price">
                        <span id="modalCurrentPrice" class="current-price"></span>
                        <span id="modalOldPrice" class="old-price"></span>
                    </div>
                    <div class="product-modal-rating">
                        <span id="modalRatingStars"></span>
                        <span id="modalRatingCount" class="rating-count"></span>
                    </div>
                    <div id="modalAvailability" class="product-availability"></div>
                    
                    <!-- Add color variations -->
                    <div class="product-variations">
                        <div class="color-options">
                            <h4>اللون:</h4>
                            <div id="productColors" class="color-selector"></div>
                        </div>
                        
                        <!-- Add size variations -->
                        <div class="size-options">
                            <h4>المقاس:</h4>
                            <div id="productSizes" class="size-selector"></div>
                        </div>
                    </div>
                    
                    <p id="modalDescription" class="product-description"></p>
                    <div class="product-modal-actions">
                        <div class="quantity-selector">
                            <button class="quantity-btn minus">-</button>
                            <input type="number" value="1" min="1" class="quantity-input">
                            <button class="quantity-btn plus">+</button>
                        </div>
                        <button class="add-to-cart-btn">
                            <i class="fas fa-shopping-cart"></i>
                            إضافة إلى السلة
                        </button>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Button -->
    <a href="https://wa.me/201017620115" class="whatsapp-btn" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>
    <footer>
        <div class="footer-container">
            <div class="footer-top">
                <div class="footer-column">
                    <h3>روابط سريعة</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">الصفحة الرئيسية</a></li>
                        <li><a href="products.html">المتجر</a></li>
                        <li><a href="cart.html">سلة التسوق</a></li>
                        <li><a href="#">سياسة الخصوصية</a></li>
                        <li><a href="#">الشروط والأحكام</a></li>
                    </ul>
                </div>
                
                <div class="footer-column" id="contact-column">
                    <h3>اتصل بنا</h3>
                    <div class="contact-info">
                        <p><i class="fas fa-home"></i> October</p>
                        <p><i class="fas fa-phone"></i> <a href="tel:01017620115">01017620115</a></p>
                        <p><i class="fas fa-envelope"></i> <a href="mailto:jojiz@jojiz.com">jojiz@jojiz.com</a></p>
                    </div>
                    <div class="social-links">
                        <!-- Social media links will be loaded dynamically from the API -->
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>عن جوجيز</h3>
                    <p class="about-text">
                        جوجيز هو متجر متخصص في ملابس الأطفال بتصميمات عصرية وخامات عالية الجودة. نسعى دائماً لتقديم أفضل المنتجات بأسعار مناسبة لجميع العملاء.
                    </p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>حقوق الطبع والنشر © Jojiz 2025. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>
    <script src="mobile-nav.js"></script>
    <script src="script.js"></script>
    <script src="filter.js"></script>
    <script src="product.js"></script>
    <script src="api.js"></script>
    <script src="social-media.js"></script>
    <script>
                // Add to cart function
                function addToCart(productId) {
            console.log('Adding product to cart:', productId);
            
            // Check if user is logged in before adding to cart
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            // Fetch product details from API before adding to cart
            fetch(`${API_BASE_URL}/api/products?filters[documentId][$eq]=${productId}&populate=*&locale=ar`)
                .then(response => response.json())
                .then(data => {
                    if (data?.data && Array.isArray(data.data) && data.data.length > 0) {
                        // Add product to cart logic here
                    }
                });
        }

        // Add to cart from modal with selected quantity
        function addToCartFromModal() {
            // Check if user is logged in
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            const productId = document.querySelector('.add-to-cart-btn').getAttribute('data-product-id');
            const quantity = parseInt(document.querySelector('.quantity-input').value) || 1;
            
            if (!productId) {
                console.error('No product ID found for adding to cart from modal');
                return;
            }
        }

        // Function to add item to cart with variation details
        function addToCartItemWithVariation(name, price, image, color, size, quantity = 1) {
            // Check if user is logged in
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            // Get current cart
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            
            // Create a unique identifier for this product+variation combination
            const itemId = `${name}-${color}-${size}`;
            
            // Check if this exact product variation already exists in cart
            const existingItemIndex = cartItems.findIndex(item => 
                item.name === name && 
                item.color === color && 
                item.size === size
            );
            
            if (existingItemIndex !== -1) {
                // Update quantity if item already exists
                cartItems[existingItemIndex].quantity += quantity;
            } else {
                // Add new item to cart with variation details
                cartItems.push({
                    name: name,
                    price: price,
                    image: image,
                    color: color,
                    size: size,
                    quantity: quantity
                });
            }
            
            // Save updated cart back to localStorage
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            
            // Update cart display
            updateCartDisplay();
        }
        
        // Function to add item to cart (similar to index.html)
        function addToCartItem(name, price, image, quantity = 1) {
            // Check if user is logged in
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            // Get current cart
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            
            // Check if product already in cart
            const existingItemIndex = cartItems.findIndex(item => item.name === name);
            
            if (existingItemIndex !== -1) {
                // Update quantity if item already exists
                cartItems[existingItemIndex].quantity += quantity;
            } else {
                // Add new item to cart
                cartItems.push({
                    name: name,
                    price: price,
                    image: image,
                    quantity: quantity
                });
            }
            
            // Save updated cart back to localStorage
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            
            // Update cart display
            updateCartDisplay();
        }

        // View product details
        function viewProduct(productId) {
            console.log('Viewing product:', productId);
            
            // If you want to require login for viewing product details also, uncomment this:
            // if (localStorage.getItem('isLoggedIn') !== 'true') {
            //     window.location.href = 'login.html';
            //     return;
            // }
            
            // Get product modal elements
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modalProductTitle');
            const modalImage = document.getElementById('modalProductImage');
            const modalCurrentPrice = document.getElementById('modalCurrentPrice');
            const modalOldPrice = document.getElementById('modalOldPrice');
            const modalDescription = document.getElementById('modalDescription');
            const productColors = document.getElementById('productColors');
            const productSizes = document.getElementById('productSizes');
        } 
    </script>
    <script>
        // Check if user is logged in
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const currentUser = localStorage.getItem('currentUser');
            const authLink = document.getElementById('authLink');
            
            if (isLoggedIn && currentUser && authLink) {
                // User is logged in, update auth link
                const userData = JSON.parse(localStorage.getItem('user_' + currentUser));
                if (userData) {
                    // Change LOGIN/REGISTER to LOGOUT
                    authLink.textContent = 'LOGOUT (' + userData.name + ')';
                    authLink.href = '#';
                    authLink.onclick = function(e) {
                        e.preventDefault();
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('currentUser');
                        window.location.reload();
                    };
                }
            }
        }
        
        // API Base URL
        const API_BASE_URL = 'https://adminjojiz.jojiz.net'; // Using the URL from product.html
        
        // Fetch products from API with filters
        async function fetchProducts(page = 1, pageSize = 12, sort = 'createdAt:desc', filters = {}) {
            try {
                const currentLocale = 'ar'; // Default to Arabic locale
                
                // Build query parameters
                const params = new URLSearchParams();
                
                // Add basic params
                params.append('populate', '*');
                params.append('locale', currentLocale);
                params.append('pagination[page]', page);
                params.append('pagination[pageSize]', pageSize);
                params.append('sort', sort);
                
                // Add category filters if selected
                if (filters.categories && filters.categories.length > 0) {
                    // Use either documentId or id based on your API structure
                    filters.categories.forEach(categoryId => {
                        // Try both formats to ensure compatibility
                        params.append('filters[$or][0][category][documentId][$eq]', categoryId);
                        params.append('filters[$or][1][category][id][$eq]', categoryId);
                    });
                }
                
                // Add brand filters if needed (assuming brands are stored as a field)
                if (filters.brands && filters.brands.length > 0) {
                    filters.brands.forEach(brand => {
                        params.append('filters[brand][$in][]', brand);
                    });
                }
                
                // Price range filter could be added here
                if (filters.minPrice) {
                    params.append('filters[product_price][$gte]', filters.minPrice);
                }
                
                if (filters.maxPrice) {
                    params.append('filters[product_price][$lte]', filters.maxPrice);
                }
                
                // Build the final URL
                const url = `${API_BASE_URL}/api/products?${params.toString()}`;
                console.log('Fetching products from:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                
                const data = await response.json();
                console.log('Products API response:', data);
                
                return data;
            } catch (error) {
                console.error('Error fetching products:', error);
                return { 
                    success: false, 
                    message: 'Network error. Please try again.', 
                    data: [], 
                    meta: { pagination: { page: 1, pageSize: 12, pageCount: 1, total: 0 } } 
                };
            }
        }
        
        // Fetch categories from API
        async function fetchCategories() {
            try {
                const url = `${API_BASE_URL}/api/categories?populate=*&locale=ar`;
                console.log('Fetching categories from:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                console.log('Categories API response:', data);
                
                return data.data || [];
            } catch (error) {
                console.error('Error fetching categories:', error);
                return [];
            }
        }
        
        // Generate product HTML based on the received API data structure
        function generateProductHTML(product) {
            // Extract product ID
            const productId = product.documentId || product.id;
            
            // Extract product name
            const productName = product.product_name || 'منتج بدون اسم';
            
            // Extract product price
            const productPrice = product.product_price || 0;
            
            // Extract product image
            let imageUrl = '';
            
            // Handle product_image different formats
            if (product.product_image) {
                if (product.product_image.formats && product.product_image.formats.medium) {
                    // Use medium format if available
                    imageUrl = product.product_image.formats.medium.url;
                } else if (product.product_image.formats && product.product_image.formats.small) {
                    // Use small format if medium is not available
                    imageUrl = product.product_image.formats.small.url;
                } else if (product.product_image.formats && product.product_image.formats.thumbnail) {
                    // Use thumbnail as last resort
                    imageUrl = product.product_image.formats.thumbnail.url;
                } else if (product.product_image.url) {
                    // Direct URL
                    imageUrl = product.product_image.url;
                }
                
                // Make sure URL is absolute
                if (imageUrl && !imageUrl.startsWith('http')) {
                    imageUrl = API_BASE_URL + imageUrl;
                }
            }
            
            // If no image found, use a placeholder
            if (!imageUrl) {
                imageUrl = 'img/product-placeholder.jpg';
            }
            
            // Generate product card HTML
            const productHtml = `
                <div class="product-card" data-product-id="${productId}">
                    <div class="product-image">
                        <img src="${imageUrl}" alt="${productName}" onerror="this.src='img/product-placeholder.jpg'">
                        <div class="product-actions">
                            <button class="action-btn" onclick="addToCart('${productId}')">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            <button class="action-btn product-view-btn" onclick="viewProduct('${productId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${productName}</h3>
                        <div class="product-price">
                            <span class="current-price">${productPrice} جنيه</span>
                        </div>
                        <div class="product-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                    </div>
                </div>
            `;
            
            return productHtml;
        }
        
        // Update filter UI with categories from API
        async function updateFilters() {
            try {
                // Get URL parameters for auto-selecting filters
                const urlParams = new URLSearchParams(window.location.search);
                const urlCategoryId = urlParams.get('categoryid');
                
                // Fetch categories
                const categories = await fetchCategories();
                
                // Update category filter UI
                const categoryFilterGroup = document.querySelector('.filter-group:first-of-type .filter-options');
                if (categoryFilterGroup && categories.length > 0) {
                    // Clear existing options
                    categoryFilterGroup.innerHTML = '';
                    
                    // Add each category
                    categories.forEach((category, index) => {
                        const categoryName = category.name || category.attributes?.name || `فئة ${index + 1}`;
                        const categoryId = category.documentId || category.attributes?.documentId || category.id;
                        
                        // Get product count for this category (if available)
                        const productCount = 0; // This would ideally come from API
                        
                        // Determine if this category should be checked based on URL parameter
                        const isChecked = urlCategoryId && urlCategoryId === categoryId.toString() ? 'checked' : '';
                        
                        const categoryHtml = `
                            <div class="filter-option">
                                <input type="checkbox" id="category-${categoryId}" name="category" value="${categoryId}" ${isChecked}>
                                <label for="category-${categoryId}">
                                    ${categoryName}
                                    <span>(${productCount})</span>
                                </label>
                            </div>
                        `;
                        
                        categoryFilterGroup.innerHTML += categoryHtml;
                    });
                    
                    // Add event listeners to new checkboxes
                    addFilterEventListeners();
                }
                
                // Update brands filter
                // Note: You would need to fetch brands from an API endpoint if available
                // For now, we'll keep the static brands but we'd replace this with API data
                
            } catch (error) {
                console.error('Error updating filters:', error);
            }
        }
        
        // Add event listeners to filter checkboxes
        function addFilterEventListeners() {
            // For category filters
            const categoryCheckboxes = document.querySelectorAll('.filter-group:first-of-type input[type="checkbox"]');
            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
            
            // For rating filters
            const ratingCheckboxes = document.querySelectorAll('.filter-group:nth-of-type(2) input[type="checkbox"]');
            ratingCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
            
            // For brand filters
            const brandCheckboxes = document.querySelectorAll('.filter-group:nth-of-type(3) input[type="checkbox"]');
            brandCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
        }
        
        // Apply selected filters and update product display
        function applyFilters() {
            // Get selected categories
            const selectedCategories = Array.from(
                document.querySelectorAll('.filter-group:first-of-type input[type="checkbox"]:checked')
            ).map(checkbox => checkbox.value);
            
            // Get selected brands
            const selectedBrands = Array.from(
                document.querySelectorAll('.filter-group:nth-of-type(3) input[type="checkbox"]:checked')
            ).map(checkbox => checkbox.value);
            
            // Create filters object
            const filters = {
                categories: selectedCategories,
                brands: selectedBrands
            };
            
            // Get current sort value
            const sortSelect = document.getElementById('sort-by');
            const sortValue = sortSelect ? sortSelect.value : 'popularity';
            
            // Map the sort value to API sort parameter
            let sortParam = 'createdAt:desc'; // default
            if (sortValue === 'price-low') {
                sortParam = 'product_price:asc';
            } else if (sortValue === 'price-high') {
                sortParam = 'product_price:desc';
            }
            
            // Update URL with category parameter (if any)
            if (selectedCategories.length === 1) {
                // If exactly one category is selected, update the URL
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('categoryid', selectedCategories[0]);
                window.history.replaceState({}, '', newUrl);
            } else if (selectedCategories.length === 0) {
                // If no categories are selected, remove the parameter
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.delete('categoryid');
                window.history.replaceState({}, '', newUrl);
            }
            // If multiple categories are selected, we don't update the URL
            
            // Update products with filters
            updateProductsGrid(1, 12, sortParam, filters);
        }
        
        // Update products grid with data from API
        async function updateProductsGrid(page = 1, pageSize = 12, sort = 'createdAt:desc', filters = {}) {
            const productsGrid = document.querySelector('.products-grid');
            
            if (!productsGrid) {
                console.error('Products grid element not found');
                return;
            }
            
            // Show loading state
            productsGrid.innerHTML = '<div class="loading-products">جاري تحميل المنتجات...</div>';
            
            const result = await fetchProducts(page, pageSize, sort, filters);
            
            if (result.data && Array.isArray(result.data) && result.data.length > 0) {
                // Clear loading message
                productsGrid.innerHTML = '';
                
                // Add each product to the grid
                result.data.forEach(product => {
                    const productHtml = generateProductHTML(product);
                    productsGrid.innerHTML += productHtml;
                });
                
                // Update pagination
                if (result.meta?.pagination) {
                    updatePagination(result.meta.pagination, filters);
                }
                
                // Update product count
                if (result.meta?.pagination) {
                    updateProductCount(result.meta.pagination);
                }
                
                // Update filter counts if possible
                updateFilterCounts(result);
            } else {
                // Show error or no products message
                productsGrid.innerHTML = `
                    <div class="no-products">
                        <p>لا توجد منتجات متاحة حالياً</p>
                    </div>
                `;
            }
        }
        
        // Update the counts in filter checkboxes based on results
        function updateFilterCounts(result) {
            // This would require aggregation data from the API
            // For now, we'll just update with the total count for categories that have products
            if (result.data && Array.isArray(result.data)) {
                // Create a map of category counts
                const categoryCounts = {};
                
                // Count products by category
                result.data.forEach(product => {
                    const categoryId = product.category?.documentId || product.category?.id;
                    if (categoryId) {
                        categoryCounts[categoryId] = (categoryCounts[categoryId] || 0) + 1;
                    }
                });
                
                // Update category filter counts
                Object.keys(categoryCounts).forEach(categoryId => {
                    const checkbox = document.getElementById(`category-${categoryId}`);
                    if (checkbox) {
                        const countSpan = checkbox.nextElementSibling.querySelector('span');
                        if (countSpan) {
                            countSpan.textContent = `(${categoryCounts[categoryId]})`;
                        }
                    }
                });
            }
        }
        
        // Update pagination based on API response
        function updatePagination(pagination, filters = {}) {
            const paginationElement = document.querySelector('.pagination');
            if (!paginationElement) return;
            
            const { page, pageCount } = pagination;
            
            let paginationHtml = '';
            
            // Previous page button
            if (page > 1) {
                paginationHtml += `<a href="#" data-page="${page - 1}" class="prev"><i class="fas fa-chevron-right"></i></a>`;
            }
            
            // Page numbers
            for (let i = 1; i <= pageCount; i++) {
                if (i === page) {
                    paginationHtml += `<a href="#" data-page="${i}" class="active">${i}</a>`;
                } else if (
                    i === 1 || 
                    i === pageCount || 
                    (i >= page - 1 && i <= page + 1)
                ) {
                    paginationHtml += `<a href="#" data-page="${i}">${i}</a>`;
                } else if (i === page - 2 || i === page + 2) {
                    paginationHtml += `<span>...</span>`;
                }
            }
            
            // Next page button
            if (page < pageCount) {
                paginationHtml += `<a href="#" data-page="${page + 1}" class="next"><i class="fas fa-chevron-left"></i></a>`;
            }
            
            paginationElement.innerHTML = paginationHtml;
            
            // Add event listeners to pagination links
            const paginationLinks = document.querySelectorAll('.pagination a[data-page]');
            if (paginationLinks && paginationLinks.length > 0) {
                paginationLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const pageNumber = parseInt(this.getAttribute('data-page') || '1');
                        
                        // Get current sort value
                        const sortSelect = document.getElementById('sort-by');
                        const sortValue = sortSelect ? sortSelect.value : 'popularity';
                        
                        // Map the sort value to API sort parameter
                        let sortParam = 'createdAt:desc'; // default
                        if (sortValue === 'price-low') {
                            sortParam = 'product_price:asc';
                        } else if (sortValue === 'price-high') {
                            sortParam = 'product_price:desc';
                        }
                        
                        // Pass the current filters when changing page
                        updateProductsGrid(pageNumber, 12, sortParam, filters);
                        
                        // Scroll to top of products
                        const productsContainer = document.querySelector('.products-grid-container');
                        if (productsContainer) {
                            productsContainer.scrollIntoView({
                                behavior: 'smooth'
                            });
                        }
                    });
                });
            }
        }
        
        // Setup filter toggle on mobile
        function setupFilterToggle() {
            const filterToggleBtn = document.getElementById('filterToggleBtn');
            const filtersSidebar = document.getElementById('filtersSidebar');
            const closeFilters = document.getElementById('closeFilters');
            
            if (filterToggleBtn && filtersSidebar) {
                filterToggleBtn.addEventListener('click', function() {
                    filtersSidebar.classList.add('active');
                });
            }
            
            if (closeFilters && filtersSidebar) {
                closeFilters.addEventListener('click', function() {
                    filtersSidebar.classList.remove('active');
                });
            }
        }
        
        // Update product count display
        function updateProductCount(pagination) {
            const countElement = document.querySelector('.products-count');
            if (!countElement || !pagination) return;
            
            const { page, pageSize, total } = pagination;
            const start = (page - 1) * pageSize + 1;
            const end = Math.min(page * pageSize, total);
            
            countElement.textContent = `عرض ${start}-${end} من ${total} منتج`;
        }
        
        // Handle sort by change
        function handleSortChange() {
            const sortSelect = document.getElementById('sort-by');
            if (!sortSelect) return;
            
            sortSelect.addEventListener('change', function() {
                // Get the current filters
                const selectedCategories = Array.from(
                    document.querySelectorAll('.filter-group:first-of-type input[type="checkbox"]:checked')
                ).map(checkbox => checkbox.value);
                
                const selectedBrands = Array.from(
                    document.querySelectorAll('.filter-group:nth-of-type(3) input[type="checkbox"]:checked')
                ).map(checkbox => checkbox.value);
                
                const filters = {
                    categories: selectedCategories,
                    brands: selectedBrands
                };
                
                let sortParam = 'createdAt:desc'; // default
                
                if (this.value === 'price-low') {
                    sortParam = 'product_price:asc';
                } else if (this.value === 'price-high') {
                    sortParam = 'product_price:desc';
                }
                
                // Update with current filters
                updateProductsGrid(1, 12, sortParam, filters);
            });
        }
        
        // View product details
        function viewProduct(productId) {
            console.log('Viewing product:', productId);
            
            // Get product modal elements
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modalProductTitle');
            const modalImage = document.getElementById('modalProductImage');
            const modalCurrentPrice = document.getElementById('modalCurrentPrice');
            const modalOldPrice = document.getElementById('modalOldPrice');
            const modalDescription = document.getElementById('modalDescription');
            const productColors = document.getElementById('productColors');
            const productSizes = document.getElementById('productSizes');
            
            // Check if modal elements exist
            if (!modal || !modalTitle || !modalImage || !modalCurrentPrice || !modalOldPrice || !modalDescription) {
                console.error('Modal elements not found');
                return;
            }
            
            // Clear previous variations
            if (productColors) productColors.innerHTML = '';
            if (productSizes) productSizes.innerHTML = '';
            
            // Fetch product details
            fetch(`${API_BASE_URL}/api/products?filters[documentId][$eq]=${productId}&populate=*&locale=ar`)
                .then(response => response.json())
                .then(data => {
                    if (data?.data && Array.isArray(data.data) && data.data.length > 0) {
                        const product = data.data[0];
                        
                        // Store the product data in a global variable for later use
                        window.currentProductData = product;
                        
                        // Set modal content
                        modalTitle.textContent = product.product_name || 'منتج بدون اسم';
                        modalCurrentPrice.textContent = `${product.product_price || 0} جنيه`;
                        modalDescription.textContent = product.product_description || 'لا يوجد وصف لهذا المنتج';
                        
                        // Handle old price if available
                        if (product.old_price) {
                            modalOldPrice.textContent = `${product.old_price} جنيه`;
                            modalOldPrice.style.display = 'inline-block';
                        } else {
                            modalOldPrice.style.display = 'none';
                        }
                        
                        // Handle product image with proper format selection
                        let imageUrl = '';
                        if (product.product_image) {
                            if (product.product_image.formats && product.product_image.formats.medium) {
                                imageUrl = product.product_image.formats.medium.url;
                            } else if (product.product_image.formats && product.product_image.formats.small) {
                                imageUrl = product.product_image.formats.small.url;
                            } else if (product.product_image.url) {
                                imageUrl = product.product_image.url;
                            }
                            
                            // Make sure URL is absolute
                            if (imageUrl && !imageUrl.startsWith('http')) {
                                imageUrl = API_BASE_URL + imageUrl;
                            }
                        }
                        
                        // Set image or placeholder
                        if (imageUrl) {
                            modalImage.src = imageUrl;
                        } else {
                            modalImage.src = 'img/product-placeholder.jpg';
                        }
                        
                        // Add error handler for image
                        modalImage.onerror = function() {
                            this.src = 'img/product-placeholder.jpg';
                        };
                        
                        // Handle product variations
                        if (product.variations && Array.isArray(product.variations) && product.variations.length > 0) {
                            // Process variations to get unique colors and sizes
                            const colors = [...new Set(product.variations.map(v => v.color))];
                            const sizes = [...new Set(product.variations.map(v => v.size))];
                            
                            // Render color options
                            if (colors.length > 0 && productColors) {
                                colors.forEach(color => {
                                    const colorElement = document.createElement('div');
                                    colorElement.className = 'color-option';
                                    colorElement.setAttribute('data-color', color);
                                    colorElement.setAttribute('data-color-name', color);
                                    colorElement.style.backgroundColor = color;
                                    
                                    // Add color name inside the circle
                                    const colorNameSpan = document.createElement('span');
                                    colorNameSpan.className = 'color-name';
                                    colorNameSpan.textContent = color;
                                    colorElement.appendChild(colorNameSpan);
                                    
                                    // For white color, add a specific data attribute
                                    if (color.toLowerCase() === 'white' || color.toLowerCase() === '#ffffff' || color.toLowerCase() === '#fff') {
                                        colorElement.setAttribute('data-color', 'white');
                                        colorNameSpan.style.color = '#000'; // Black text for white background
                                    }
                                    
                                    // For black color, add a specific data attribute
                                    if (color.toLowerCase() === 'black' || color.toLowerCase() === '#000000' || color.toLowerCase() === '#000') {
                                        colorElement.setAttribute('data-color', 'black');
                                        colorNameSpan.style.color = '#fff'; // White text for black background
                                    }
                                    
                                    // Add event listener
                                    colorElement.addEventListener('click', function() {
                                        // Remove active class from all color options
                                        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                                        // Add active class to clicked option
                                        this.classList.add('active');
                                        // Update available sizes for this color
                                        updateSizesForColor(product.variations, color);
                                    });
                                    
                                    productColors.appendChild(colorElement);
                                });
                                
                                // Activate the first color
                                if (productColors.firstChild) {
                                    productColors.firstChild.classList.add('active');
                                    updateSizesForColor(product.variations, colors[0]);
                                }
                            } else {
                                // Hide color section if no colors available
                                document.querySelector('.color-options').style.display = 'none';
                            }
                        } else {
                            // Hide variations section if no variations available
                            document.querySelector('.product-variations').style.display = 'none';
                        }
                        
                        // Set product ID for "Add to Cart" button
                        const addToCartBtn = modal.querySelector('.add-to-cart-btn');
                        if (addToCartBtn) {
                            addToCartBtn.setAttribute('data-product-id', productId);
                        }
                        
                        // Show modal
                        modal.style.display = 'block';
                    } else {
                        console.error('Product not found');
                        alert('عذراً، لم يتم العثور على المنتج');
                    }
                })
                .catch(error => {
                    console.error('Error fetching product details:', error);
                    alert('عذراً، حدث خطأ أثناء تحميل تفاصيل المنتج');
                });
        }
        
        // Update sizes available for selected color
        function updateSizesForColor(variations, selectedColor) {
            const productSizes = document.getElementById('productSizes');
            const modalCurrentPrice = document.getElementById('modalCurrentPrice');
            
            if (!productSizes || !variations || !selectedColor) return;
            
            // Clear previous sizes
            productSizes.innerHTML = '';
            
            // Filter variations for selected color
            const colorVariations = variations.filter(v => v.color === selectedColor);
            
            // Create size buttons
            colorVariations.forEach(variation => {
                const sizeBtn = document.createElement('button');
                sizeBtn.className = 'size-btn';
                sizeBtn.setAttribute('data-size', variation.size);
                sizeBtn.setAttribute('data-price', variation.price);
                sizeBtn.setAttribute('data-variation-id', variation.documentId);
                sizeBtn.textContent = variation.size;
                
                // Add event listener to update price when size is selected
                sizeBtn.addEventListener('click', function() {
                    // Remove active class from all size buttons
                    document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update price based on selected size
                    const price = parseFloat(this.getAttribute('data-price'));
                    modalCurrentPrice.textContent = `${price} جنيه`;
                    
                    // Store selected variation
                    window.selectedVariation = {
                        documentId: this.getAttribute('data-variation-id'),
                        color: selectedColor,
                        size: this.getAttribute('data-size'),
                        price: price
                    };
                });
                
                productSizes.appendChild(sizeBtn);
            });
            
            // Select first size by default
            if (productSizes.firstChild) {
                productSizes.firstChild.click();
            }
        }
        
        // Add to cart from modal with selected quantity
        function addToCartFromModal() {
            const productId = document.querySelector('.add-to-cart-btn').getAttribute('data-product-id');
            const quantity = parseInt(document.querySelector('.quantity-input').value) || 1;
            
            if (!productId) {
                console.error('No product ID found for adding to cart from modal');
                return;
            }
            
            // Get selected variation if available
            const selectedVariation = window.selectedVariation;
            const product = window.currentProductData;
            
            if (selectedVariation) {
                // Add product with variation details
                const name = product.product_name || 'منتج بدون اسم';
                const price = selectedVariation.price;
                
                // Get product image
                let imageUrl = '';
                if (product.product_image) {
                    if (product.product_image.formats && product.product_image.formats.medium) {
                        imageUrl = product.product_image.formats.medium.url;
                    } else if (product.product_image.formats && product.product_image.formats.small) {
                        imageUrl = product.product_image.formats.small.url;
                    } else if (product.product_image.url) {
                        imageUrl = product.product_image.url;
                    }
                    
                    // Make sure URL is absolute
                    if (imageUrl && !imageUrl.startsWith('http')) {
                        imageUrl = API_BASE_URL + imageUrl;
                    }
                }
                
                // Add to cart with selected quantity and variation details
                addToCartItemWithVariation(name, price, imageUrl, selectedVariation.color, selectedVariation.size, quantity);
                
                // Close modal
                const modal = document.getElementById('productModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Show notification
                alert('تمت إضافة المنتج إلى سلة التسوق');
            } else {
                // Fallback to original method if no variation is selected
                fetch(`${API_BASE_URL}/api/products?filters[documentId][$eq]=${productId}&populate=*&locale=ar`)
                    .then(response => response.json())
                    .then(data => {
                        if (data?.data && Array.isArray(data.data) && data.data.length > 0) {
                            const product = data.data[0];
                            
                            // Extract necessary product details
                            const name = product.product_name || 'منتج بدون اسم';
                            const price = product.product_price || 0;
                            
                            // Get product image
                            let imageUrl = '';
                            if (product.product_image) {
                                if (product.product_image.formats && product.product_image.formats.medium) {
                                    imageUrl = product.product_image.formats.medium.url;
                                } else if (product.product_image.formats && product.product_image.formats.small) {
                                    imageUrl = product.product_image.formats.small.url;
                                } else if (product.product_image.url) {
                                    imageUrl = product.product_image.url;
                                }
                                
                                // Make sure URL is absolute
                                if (imageUrl && !imageUrl.startsWith('http')) {
                                    imageUrl = API_BASE_URL + imageUrl;
                                }
                            }
                            
                            // Add to cart with selected quantity
                            addToCartItem(name, price, imageUrl, quantity);
                            
                            // Close modal
                            const modal = document.getElementById('productModal');
                            if (modal) {
                                modal.style.display = 'none';
                            }
                            
                            // Show notification
                            alert('تمت إضافة المنتج إلى سلة التسوق');
                        } else {
                            console.error('Product not found');
                            alert('عذراً، لم يتم العثور على المنتج');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching product details for cart:', error);
                        alert('عذراً، حدث خطأ أثناء إضافة المنتج إلى السلة');
                    });
            }
        }
        
        // Function to add item to cart with variation details
        function addToCartItemWithVariation(name, price, image, color, size, quantity = 1) {
            // Check if user is logged in
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            // Get current cart
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            
            // Create a unique identifier for this product+variation combination
            const itemId = `${name}-${color}-${size}`;
            
            // Check if this exact product variation already exists in cart
            const existingItemIndex = cartItems.findIndex(item => 
                item.name === name && 
                item.color === color && 
                item.size === size
            );
            
            if (existingItemIndex !== -1) {
                // Update quantity if item already exists
                cartItems[existingItemIndex].quantity += quantity;
            } else {
                // Add new item to cart with variation details
                cartItems.push({
                    name: name,
                    price: price,
                    image: image,
                    color: color,
                    size: size,
                    quantity: quantity
                });
            }
            
            // Save updated cart back to localStorage
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            
            // Update cart display
            updateCartDisplay();
        }
        
        // Function to add item to cart (similar to index.html)
        function addToCartItem(name, price, image, quantity = 1) {
            // Check if user is logged in
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            // Get current cart
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            
            // Check if product already in cart
            const existingItemIndex = cartItems.findIndex(item => item.name === name);
            
            if (existingItemIndex !== -1) {
                // Update quantity if item already exists
                cartItems[existingItemIndex].quantity += quantity;
            } else {
                // Add new item to cart
                cartItems.push({
                    name: name,
                    price: price,
                    image: image,
                    quantity: quantity
                });
            }
            
            // Save updated cart back to localStorage
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            
            // Update cart display
            updateCartDisplay();
        }
        
        // Function to update cart display
        function updateCartDisplay() {
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            const cartTotal = document.getElementById('cart-total');
            
            // Calculate total price and count
            let totalPrice = 0;
            let totalItems = 0;
            
            cartItems.forEach(item => {
                totalPrice += item.price * item.quantity;
                totalItems += item.quantity;
            });
            
            // Update cart total in UI
            if (cartTotal) {
                cartTotal.textContent = `${totalPrice.toFixed(2)} جنيه`;
            }
            
            // Update cart count if you have a separate element for it
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) {
                cartCount.textContent = totalItems;
            }
        }
        
        // Add to cart function
        function addToCart(productId) {
            console.log('Adding product to cart:', productId);
            
            // Check if user is logged in before adding to cart
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            // Fetch product details from API before adding to cart
            fetch(`${API_BASE_URL}/api/products?filters[documentId][$eq]=${productId}&populate=*&locale=ar`)
                .then(response => response.json())
                .then(data => {
                    if (data?.data && Array.isArray(data.data) && data.data.length > 0) {
                        const product = data.data[0];
                        
                        // Extract necessary product details
                        const name = product.product_name || 'منتج بدون اسم';
                        const price = product.product_price || 0;
                        
                        // Get product image
                        let imageUrl = '';
                        if (product.product_image) {
                            if (product.product_image.formats && product.product_image.formats.medium) {
                                imageUrl = product.product_image.formats.medium.url;
                            } else if (product.product_image.formats && product.product_image.formats.small) {
                                imageUrl = product.product_image.formats.small.url;
                            } else if (product.product_image.url) {
                                imageUrl = product.product_image.url;
                            }
                            
                            // Make sure URL is absolute
                            if (imageUrl && !imageUrl.startsWith('http')) {
                                imageUrl = API_BASE_URL + imageUrl;
                            }
                        }
                        
                        // Use a common function to add item to cart
                        addToCartItem(name, price, imageUrl);
                        
                        // Show notification
                        alert('تمت إضافة المنتج إلى سلة التسوق');
                    } else {
                        console.error('Product not found');
                        alert('عذراً، لم يتم العثور على المنتج');
                    }
                })
                .catch(error => {
                    console.error('Error fetching product details for cart:', error);
                    alert('عذراً، حدث خطأ أثناء إضافة المنتج إلى السلة');
                });
        }
        
        // Load content when the DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            updateCartDisplay(); // Display cart items from localStorage
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('categoryid');
            
            // Update filters from API before loading products
            updateFilters().then(() => {
                if (categoryId) {
                    // If we have a category ID in the URL, apply it as a filter
                    console.log('Filtering by category ID:', categoryId);
                    
                    // Check if there's a checkbox for this category and select it
                    const categoryCheckbox = document.getElementById(`category-${categoryId}`);
                    if (categoryCheckbox) {
                        categoryCheckbox.checked = true;
                    }
                    
                    // Create filters object with the category ID
                    const filters = {
                        categories: [categoryId],
                        brands: []
                    };
                    
                    // Get current sort value (or use default)
                    const sortSelect = document.getElementById('sort-by');
                    const sortValue = sortSelect ? sortSelect.value : 'popularity';
                    
                    // Map the sort value to API sort parameter
                    let sortParam = 'createdAt:desc'; // default
                    if (sortValue === 'price-low') {
                        sortParam = 'product_price:asc';
                    } else if (sortValue === 'price-high') {
                        sortParam = 'product_price:desc';
                    }
                    
                    // Load products with the category filter
                    updateProductsGrid(1, 12, sortParam, filters);
                } else {
                    // Load all products if no category filter is specified
                    updateProductsGrid();
                }
            });
            
            handleSortChange();
            setupFilterToggle();
            
            // Setup modal interactions
            const modal = document.getElementById('productModal');
            const closeModal = document.querySelector('.close-modal');
            
            if (closeModal && modal) {
                closeModal.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
                
                // Close modal when clicking outside
                window.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // Setup quantity buttons in modal
            const minusBtn = document.querySelector('.quantity-btn.minus');
            const plusBtn = document.querySelector('.quantity-btn.plus');
            const quantityInput = document.querySelector('.quantity-input');
            
            if (minusBtn && quantityInput) {
                minusBtn.addEventListener('click', function() {
                    const value = parseInt(quantityInput.value);
                    if (value > 1) {
                        quantityInput.value = value - 1;
                    }
                });
            }
            
            if (plusBtn && quantityInput) {
                plusBtn.addEventListener('click', function() {
                    const value = parseInt(quantityInput.value);
                    quantityInput.value = value + 1;
                });
            }
            
            // Add to cart from modal
            const addToCartBtn = document.querySelector('.add-to-cart-btn');
            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', addToCartFromModal);
            }
            
            // Check for mobile authentication link as well
            const mobileAuthLink = document.getElementById('mobileAuthLink');
            if (mobileAuthLink) {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const currentUser = localStorage.getItem('currentUser');
                
                if (isLoggedIn && currentUser) {
                    // User is logged in, update mobile auth link
                    const userData = JSON.parse(localStorage.getItem('user_' + currentUser));
                    if (userData) {
                        mobileAuthLink.textContent = 'تسجيل الخروج (' + userData.name + ')';
                        mobileAuthLink.href = '#';
                        mobileAuthLink.onclick = function(e) {
                            e.preventDefault();
                            localStorage.removeItem('isLoggedIn');
                            localStorage.removeItem('currentUser');
                            window.location.reload();
                        };
                    }
                }
            }
        });
    </script>
</body>
</html> 